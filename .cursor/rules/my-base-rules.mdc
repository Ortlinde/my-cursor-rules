---
description: Base coding rule for ai.
globs: 
alwaysApply: true
---

# Base Coding Rules (ENFORCED)

## Environment Requirements

- [ ] **MUST**: Use CRLF line endings for all files
  - ğŸ¯ Context: Windows environment requirement
  - âœ… Action: Ensure all files end with CRLF (\r\n)
  - âŒ Violation: Files with LF (\n) only
  - âœ… Pass: Files with CRLF line endings

- [ ] **MUST NOT**: Use graphical characters in executable code
  - ğŸ¯ Context: Unity cannot display non-ASCII characters properly
  - âŒ Violation: Comments with emoji, box-drawing, Unicode art, or any non-ASCII characters
  - âŒ Violation: String literals with emoji or special Unicode characters
  - âœ… Pass: Pure ASCII text in all code, comments, and string literals

---

## MUST Requirements (Violations = Blocking)

### File & Class Structure

- [ ] **MUST**: One public class per file
  - âŒ Violation: Multiple public classes in `Example.cs`
  - âœ… Pass: Single public class per `.cs` file

- [ ] **MUST**: One concept per class
  - âŒ Violation: `UserManagerValidator` (æ··åˆç®¡ç†èˆ‡é©—è­‰)
  - âœ… Pass: `UserValidator` (å–®ä¸€è·è²¬ï¼šé©—è­‰)

- [ ] **MUST**: One behavior per method
  - âŒ Violation: `ProcessAndSaveData()` (å¤šå€‹å‹•ä½œ)
  - âœ… Pass: `ProcessData()` + `SaveData()` (åˆ†é›¢è·è²¬)

### Member Ordering

- [ ] **MUST**: Follow standardized member ordering within classes
  - ğŸ“‹ **Block Order** (top to bottom):
    1. Inner Classes
    2. Delegates (includes delegate definitions and event members)
    3. Fields
    4. Properties
    5. Constructors
    6. Normal Functions
    7. Unity Lifecycle Functions
  
  - ğŸ”’ **Access Modifier Order** (within each block):
    1. [SerializeField] annotated members
    2. (blank line)
    3. const members
    4. readonly members
    5. (blank line)
    6. public
    7. protected
    8. private
  
  - ğŸ“ **Method Order** (within same access level):
    - Methods ordered by call sequence (caller before callee)
    - Helper methods placed after methods that call them
  
  - ğŸ¯ **Unity Lifecycle Order** (within Unity Lifecycle Functions block):
    - Follow official Unity execution order: https://docs.unity3d.com/6000.3/Documentation/Manual/execution-order.html
    - Initialization: Awake -> OnEnable -> Start
    - Physics: FixedUpdate -> Physics callbacks
    - Game Logic: Update -> LateUpdate
    - Rendering: OnPreCull -> OnPreRender -> OnPostRender -> OnRenderImage
    - Deinitialization: OnDisable -> OnDestroy
  
  - ğŸ“¦ **Region Wrapping**:
    - âœ… Each major block MUST be wrapped with #region
    - Example: `#region Fields`, `#region Unity Lifecycle`, etc.
  
  - âŒ **Violations**:
    - Public field placed before [SerializeField]
    - Constructor placed after normal functions
    - OnDestroy placed before Awake
    - Missing #region for major blocks
  
  - âœ… **Correct Example**:
```csharp
public class Example : MonoBehaviour
{
    #region Inner Classes
    private class HelperClass { }
    #endregion

    #region Delegates
    public delegate void OnValueChanged(int newValue);
    public event System.Action OnStateChanged;
    #endregion

    #region Fields

    [SerializeField] private int serializedValue;

    private const int MAX_COUNT = 100;
    private readonly int _readonlyValue;

    public int publicField;
    protected int protectedField;
    private int privateField;

    #endregion

    #region Properties
    public int PublicProperty { get; set; }
    private int PrivateProperty { get; set; }
    #endregion

    #region Constructors
    public Example() { }
    #endregion

    #region Normal Functions
    public void Initialize() { }
    private void InitializeInternal() { } // Called by Initialize
    #endregion

    #region Unity Lifecycle
    private void Awake() { }
    private void OnEnable() { }
    private void Start() { }
    private void FixedUpdate() { }
    private void Update() { }
    private void LateUpdate() { }
    private void OnDisable() { }
    private void OnDestroy() { }
    #endregion
}
```

### Code Quality Standards

- [ ] **MUST**: File length â‰¤ 200 lines
  - ğŸ“ Count: Exclude blank lines and comments
  - âŒ Violation: File with 201+ lines
  - âœ… Pass: File with â‰¤ 200 lines

- [ ] **MUST**: Method parameters â‰¤ 3
  - ğŸ“ Count: Constructor and method parameters
  - âŒ Violation: `Initialize(a, b, c, d)` (4 parameters)
  - âœ… Pass: `Initialize(config)` (1 parameter object)

- [ ] **MUST**: Follow SOLID principles
  - **S**ingle Responsibility: One reason to change
  - **O**pen/Closed: Extend without modifying
  - **L**iskov Substitution: Subtypes replaceable
  - **I**nterface Segregation: Minimal interfaces
  - **D**ependency Inversion: Depend on abstractions

- [ ] **MUST**: Follow DRY (Don't Repeat Yourself)
  - âŒ Violation: Identical logic copied across 3+ locations
  - âœ… Pass: Shared logic extracted to reusable method
  - ğŸ’¡ Tolerance: <3 lines duplicated <3 times (acceptable)

### Scope Control

- [ ] **MUST**: When user explicitly specifies modification scope, do NOT modify outside that scope
  - ğŸ¯ Trigger: User highlights/mentions specific method + says "only modify this method"
  - âŒ Violation: User marks `CalculateScore()`, AI also modifies `ValidateInput()`
  - âŒ Violation: User marks method lines 45-60, AI modifies line 30
  - âœ… Pass: User marks `CalculateScore()`, AI only changes within that method
  - ğŸ’¡ **If scope is insufficient**:
    - âŒ DO NOT: Silently modify other areas
    - âœ… DO: Stop and inform user: "This requires changes outside the method. Proceed?"
    - âœ… DO: Explain what else needs to change and why
  - ğŸ’¡ **Assumption**: User's scope declaration means they believe the task is completable within that scope

---

## SHOULD Requirements (Strong Recommendations)

### Design Patterns

- [ ] **SHOULD NOT**: Use if/else or switch for type comparison when logic is complex
  - âŒ Poor Design: `if (type == "A") ... else if (type == "B") ... else if (type == "C")`
  - âœ… Better: Strategy Pattern, Factory Pattern, Polymorphism
  - ğŸ’¡ **Acceptable if/else usage**:
    - Simple boolean conditions (`if (isEnabled)`)
    - 2-3 branches with trivial logic (<5 lines per branch)
    - One-time validation checks
    - Early returns for guard clauses
  - ğŸ¯ **Consider refactoring when**:
    - 4+ branches in if/else chain
    - Each branch >10 lines
    - Same pattern repeated across multiple methods
    - Type checking (instanceof, typeof comparisons)

### Code Organization

- [ ] **SHOULD**: Extract methods when logic exceeds 20 lines
  - ğŸ’¡ Guideline: Aim for methods â‰¤ 15 lines
  - ğŸ’¡ Acceptable: Up to 25 lines if highly cohesive

- [ ] **SHOULD**: Split large classes into smaller components
  - ğŸ’¡ Guideline: Aim for â‰¤ 150 lines per class
  - ğŸ’¡ Trigger: When class has 5+ unrelated methods

---

## MUST NOT Requirements (Strict Prohibitions)

- [ ] **MUST NOT**: Generate code without explicit user instruction
  - âŒ Prohibited: "I also added X for convenience"
  - âœ… Allowed: "Should I also add X?"

- [ ] **MUST NOT**: Introduce >3 new concepts per iteration (unless explicitly instructed)
  - ğŸ“ Count: New classes, interfaces, patterns combined
  - âŒ Violation: Adding 5 new classes **without user requesting it**
  - âœ… Pass: Adding 2 new classes, then confirming before more
  - ğŸ’¡ **Exception**: User explicitly requests specific number
    - âœ… Allowed: "Split this file into 5 classes" â†’ Create all 5
    - âœ… Allowed: "Refactor using Strategy pattern" â†’ Create all required classes
    - âŒ Prohibited: User asks to "improve code" â†’ AI adds 5 classes unprompted

- [ ] **MUST NOT**: Auto-generate ideas without approval
  - âŒ Prohibited: Unsolicited refactoring suggestions
  - âœ… Allowed: "I noticed X. Would you like me to improve it?"

---

## Quantified Standards Summary

| Metric | Limit | Tolerance | Blocking |
|--------|-------|-----------|----------|
| File length | â‰¤ 200 lines | 210 lines | 250+ lines |
| Method params | â‰¤ 3 | 4 (if justified) | 5+ params |
| Method length | â‰¤ 20 lines | 25 lines | 40+ lines |
| New concepts | â‰¤ 3 per turn* | 4 (if related) | 5+ unprompted |
| Code duplication | <3 occurrences | 3 occurrences | 4+ occurrences |
| if/else branches | â‰¤ 3 branches | 3-4 branches | 5+ branches |

*Exception: When user explicitly requests specific number (e.g., "split into 5 classes")

---

## Enforcement Priority

1. **ğŸ”´ Blocking Issues** (MUST fix before proceeding)
   - Modified code outside user-specified scope
   - File >250 lines
   - Method >5 parameters
   - Violated SOLID principles

2. **ğŸŸ¡ Warning Issues** (SHOULD address)
   - File 200-250 lines
   - Method 4 parameters
   - Method >25 lines

3. **ğŸŸ¢ Advisory Issues** (Consider improving)
   - File 150-200 lines
   - Opportunities for design patterns
