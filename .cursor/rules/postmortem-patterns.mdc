---
description: Postmortem knowledge base - Bug patterns and prevention strategies
alwaysApply: true
---

# Postmortem Knowledge Base

> **Purpose**: Record historical bug patterns to prevent regressions during Vibe Coding.

## Knowledge Base Location

- [ ] **MUST**: Historical bug patterns are stored in `.cursor/postmortem/`
  - ğŸ“‚ Database Path: `.cursor/postmortem/`
  - ğŸ“‹ Structure:
    - `categories/` - Bug patterns by category (Unity Lifecycle, Unity Editor, Async, Memory, Architecture)
    - `changelists/` - Detailed analysis by CL number
    - `README.md` - Database overview and workflow
  - ğŸ¯ This database grows with project experience
  - ğŸ“ Current file provides common prevention checklist only

## Integration with Self-Review Protocol

- [ ] **MUST**: Check this knowledge base during self-review (Step 2)
  - ğŸ“‚ Triggered by: `.cursor/rules/self-review-protocol.mdc`
  - ğŸ¯ Purpose: Prevent known bug patterns from recurring
  - âœ… Action: Compare code changes against patterns below
  - âŒ Violation: If pattern detected, flag in review report

- [ ] **MUST**: Search postmortem database when modifying specific areas
  - ğŸ” Action: Use `grep` or `codebase_search` to query `.cursor/postmortem/`
  - ğŸ“ Timing: When touching Unity lifecycle, async, memory, or architecture code
  - âœ… Example: Modifying `Awake()` â†’ Search "Awake" in `.cursor/postmortem/categories/unity-lifecycle.md`
  - âœ… Example: Adding coroutine â†’ Search "coroutine" in `.cursor/postmortem/categories/`

- [ ] **MUST**: Report pattern matches in self-review report
  - Format: "Triggered Postmortem [PXXX]: [pattern name] (source: .cursor/postmortem/...)"
  - Example: "Triggered Postmortem P001: lifecycle order issue (source: .cursor/postmortem/categories/unity-lifecycle.md)"

---

## Common Bug Prevention Checklist

AI MUST check the following common pitfalls when generating code:

### Unity-Specific Risks

- [ ] **Null Reference Exceptions**
  - âœ… Check: GetComponent results are null-checked
  - âŒ Bad: `GetComponent<Rigidbody>().velocity = ...`
  - âœ… Good: `var rb = GetComponent<Rigidbody>(); if (rb != null) rb.velocity = ...`

- [ ] **Lifecycle Order Issues**
  - âœ… Check: Awake/Start/OnEnable execution order respected
  - âŒ Bad: Accessing other component's data in Awake before it's initialized
  - âœ… Good: Initialize self in Awake, reference others in Start

- [ ] **Coroutine Leaks**
  - âœ… Check: Every StartCoroutine has corresponding StopCoroutine
  - âŒ Bad: StartCoroutine without cleanup
  - âœ… Good: Store coroutine reference and stop in OnDisable/OnDestroy

- [ ] **Event Subscription Leaks**
  - âœ… Check: Every += has corresponding -= in OnDestroy
  - âŒ Bad: `eventSystem.OnAction += Handler;` without unsubscribe
  - âœ… Good: Unsubscribe in OnDestroy or OnDisable

- [ ] **Initialization/Disposal Order**
  - âœ… Check: Disposal order is REVERSE of initialization order
  - âŒ Bad: `Init Aâ†’Bâ†’C, Dispose Aâ†’Bâ†’C` (disposes foundation first)
  - âœ… Good: `Init Aâ†’Bâ†’C, Dispose Câ†’Bâ†’A` (disposes dependents first)
  - ğŸ¯ Rule: If C depends on B, and B depends on A, dispose C first

- [ ] **ScriptableObject Shared State**
  - âœ… Check: Runtime modifications don't affect asset
  - âŒ Bad: Modifying ScriptableObject values directly at runtime
  - âœ… Good: Create runtime instance copy for modifications

- [ ] **GameObject.Find in Update**
  - âœ… Check: No Find/FindObjectOfType in Update/FixedUpdate
  - âŒ Bad: `GameObject.Find("Player")` in Update
  - âœ… Good: Cache reference in Awake/Start

- [ ] **Frequent GetComponent Calls**
  - âœ… Check: Cache components instead of repeated GetComponent
  - âŒ Bad: `GetComponent<Rigidbody>()` called every frame
  - âœ… Good: Cache in Awake: `_rigidbody = GetComponent<Rigidbody>()`

### Unity Editor Risks

- [ ] **Scene Not Loaded in Editor Window**
  - âœ… Check: Custom Editor Window checks if scene is loaded before accessing scene objects
  - âŒ Bad: `GameObject.Find("Player")` in OnGUI without checking scene state
  - âœ… Good: Check `SceneManager.GetActiveScene().isLoaded` before accessing scene objects
  - ğŸ¯ Risk: Editor Window auto-opens on Unity startup before scene loads

- [ ] **Stale Scene References in Editor**
  - âœ… Check: Clear cached scene object references on scene change
  - âŒ Bad: Cached GameObject reference persists across scene reloads
  - âœ… Good: Subscribe to EditorSceneManager.sceneOpened and clear references

- [ ] **Missing EditorUtility.SetDirty**
  - âœ… Check: Call SetDirty after modifying scene objects in Editor scripts
  - âŒ Bad: Modify object without marking dirty (changes lost)
  - âœ… Good: `EditorUtility.SetDirty(obj)` or `EditorSceneManager.MarkSceneDirty(scene)`

### C# General Risks

- [ ] **Collection Modification During Iteration**
  - âœ… Check: Collections not modified while iterating
  - âŒ Bad: `foreach (var item in list) { list.Remove(item); }`
  - âœ… Good: Iterate over copy or use for loop backwards

- [ ] **Async Exception Handling**
  - âœ… Check: No async void methods (except event handlers)
  - âŒ Bad: `async void ProcessData()` swallows exceptions
  - âœ… Good: `async Task ProcessDataAsync()` with try-catch

- [ ] **Closure Variable Capture**
  - âœ… Check: Loop variables captured correctly in lambdas
  - âŒ Bad: `for (int i=0; i<10; i++) { action += () => Use(i); }`
  - âœ… Good: `for (int i=0; i<10; i++) { int copy=i; action += () => Use(copy); }`

- [ ] **Boxing Performance**
  - âœ… Check: Avoid frequent boxing of value types
  - âŒ Bad: `object box = 42;` in hot path
  - âœ… Good: Use generics or avoid boxing

### Architecture Risks

- [ ] **Circular Dependencies**
  - âœ… Check: No bidirectional references between modules
  - âŒ Bad: `ClassA` references `ClassB` and `ClassB` references `ClassA`
  - âœ… Good: Use dependency injection or events for decoupling

- [ ] **Single Responsibility Violation**
  - âœ… Check: Class has one clear responsibility
  - âŒ Bad: `PlayerController` handles input, physics, animation, UI
  - âœ… Good: Split into `PlayerInput`, `PlayerMovement`, `PlayerAnimation`

- [ ] **Magic Numbers and Strings**
  - âœ… Check: Constants used instead of hardcoded values
  - âŒ Bad: `if (type == "warrior")` or `speed = 5.5f`
  - âœ… Good: `if (type == CharacterType.Warrior)` or `speed = WALK_SPEED`

### Code Structure Risks

- [ ] **Member Ordering Violation (MUST CHECK ON EVERY FILE MODIFICATION)**
  - âœ… Check: When modifying ANY file, verify ENTIRE file follows member ordering rules
  - ğŸ¯ Trigger: Any code modification to a class file
  - ğŸ“ Reference: `my-base-rules.mdc` Member Ordering section
  - âœ… Block Order (top to bottom):
    1. Inner Classes
    2. Delegates (delegate definitions and event members)
    3. Fields ([SerializeField] first, then const, readonly, then public/protected/private)
    4. Properties
    5. Constructors
    6. Normal Functions (public before private, caller before callee)
    7. Unity Lifecycle Functions (Awake -> OnEnable -> Start -> Update -> OnDisable -> OnDestroy)
  - âœ… Check: Each block wrapped with #region
  - âŒ Bad: Unity lifecycle methods scattered among normal functions
  - âŒ Bad: Private helper methods placed before public methods that call them
  - âŒ Bad: Missing #region wrappers
  - âœ… Action: If violations found, fix ordering BEFORE completing modification

- [ ] **Redundant Comments**
  - âœ… Check: Comments do not repeat what code already says
  - âŒ Bad: `// Calculate point` above `CalculatePoint()` method
  - âŒ Bad: `// Blue color` when color comes from config file
  - âœ… Good: Extract logic to self-explanatory method names instead of comments
  - ğŸ¯ Rule: If comment explains WHAT, consider renaming/extracting method instead

---

## Known Bug Patterns (Historical)

When specific bugs are discovered and fixed, add them here using this format:

### Template Format

```markdown
### [PXXX] Short Title

- **Symptom**: What users/tests observed
- **Root Cause**: Technical reason for the bug
- **Fix Strategy**: Correct solution approach
- **Related Changelist**: CL#12345
- **Affected Files**: `Path/To/File.cs`
- **Date**: YYYY-MM-DD
- **Prevention**: How to avoid in future
```

---

## Database Search Strategy

### When to Search the Postmortem Database

- [ ] **MUST**: Search `.cursor/postmortem/` when modifying code in these areas:

| Code Area | Search Location | Keywords |
|-----------|----------------|----------|
| Unity lifecycle (`Awake`, `Start`, `OnEnable`, `OnDestroy`) | `categories/unity-lifecycle.md` | Method names, "lifecycle", "order" |
| Unity Editor (`EditorWindow`, `CustomEditor`, Editor scripts) | `categories/unity-editor.md` | "EditorWindow", "scene loading", "SetDirty" |
| Coroutines (`StartCoroutine`, `StopCoroutine`) | `categories/async-patterns.md` | "coroutine", "async", "yield" |
| Event subscriptions (`+=`, `-=`) | `categories/memory-management.md` | "event", "subscribe", "leak" |
| GetComponent, Find | `categories/memory-management.md` | "GetComponent", "Find", "cache" |
| Class architecture changes | `categories/architecture.md` | "dependency", "circular", "responsibility" |
| ScriptableObject modifications | `categories/architecture.md` | "ScriptableObject", "shared state" |
| **Any class file modification** | `my-base-rules.mdc` | "Member Ordering", "#region" |

### How to Search

- [ ] **MUST**: Use `grep` or `rg` tool to search postmortem database
  ```
  Example 1: Modifying Awake() method
  â†’ grep "Awake" -i path:.cursor/postmortem/categories/unity-lifecycle.md
  
  Example 2: Adding coroutine
  â†’ grep "coroutine" -i path:.cursor/postmortem/categories/
  
  Example 3: Modifying class structure
  â†’ grep "circular\|dependency" -i path:.cursor/postmortem/categories/architecture.md
  ```

- [ ] **MUST**: Review search results before completing code changes
  - âœ… If matches found: Read relevant sections
  - âœ… If pattern applies: Mention in self-review report
  - âœ… If unsure: Search broader with `path:.cursor/postmortem/`

### Search Optimization

- [ ] **SHOULD**: Search specific category first (faster)
  - Unity lifecycle issues â†’ `categories/unity-lifecycle.md`
  - Unity Editor issues â†’ `categories/unity-editor.md`
  - Async issues â†’ `categories/async-patterns.md`
  - Memory issues â†’ `categories/memory-management.md`
  - Architecture issues â†’ `categories/architecture.md`

- [ ] **SHOULD**: Search entire database if no matches in specific category
  - Use: `grep "[keyword]" -i path:.cursor/postmortem/`

---

## Historical Patterns Database

**Location**: `.cursor/postmortem/categories/` and `.cursor/postmortem/changelists/`

**Note**: Historical patterns are stored externally to keep this rule file concise.
AI MUST search the database using `grep` tool when modifying relevant code areas.

### ğŸ”´ High Risk Patterns

See: `.cursor/postmortem/categories/` (search using grep)

### ğŸŸ¡ Medium Risk Patterns

See: `.cursor/postmortem/categories/` (search using grep)

### ğŸŸ¢ Low Risk Patterns

See: `.cursor/postmortem/categories/` (search using grep)

---

## Usage Guidelines

### For AI During Code Generation

- [ ] **BEFORE modifying code**: Review checklist above
- [ ] **BEFORE modifying code**: Search postmortem database for relevant keywords
- [ ] **AFTER generating code**: Verify no patterns triggered
- [ ] **DURING self-review**: Compare against known patterns
- [ ] **IN review report**: Flag any pattern matches with database source

### For Adding New Patterns

When a new bug is discovered:

1. **Document in database**: Add to appropriate file in `.cursor/postmortem/categories/`
2. **Create CL analysis**: Add detailed analysis in `.cursor/postmortem/changelists/CL-XXXXX.md`
3. **Update category file**: Add pattern summary to relevant category
4. **Update prevention checklist**: Add to Common Bug Prevention Checklist if widely applicable
5. **Update statistics**: Reflect new pattern count in table below

---

## Statistics Summary

| Category | Count | Last Updated |
|----------|-------|--------------|
| **Prevention Checklist Items** | **20** | 2026-01-26 |
| **Database Categories** | **5** | 2026-01-26 |
| Historical High Risk Patterns | See database | - |
| Historical Medium Risk Patterns | See database | - |
| Historical Low Risk Patterns | See database | - |

**Note**: Historical patterns are stored in `.cursor/postmortem/` database.
Use `grep` tool to search for specific patterns when modifying related code.

---

## AI Commitment

**I, as the AI assistant, commit to**:
- âœ… Checking ALL items in the prevention checklist before submitting code
- âœ… **Searching `.cursor/postmortem/` database using `grep` tool** when modifying relevant code areas
- âœ… Comparing code changes against known bug patterns (both checklist and database)
- âœ… Flagging pattern matches in self-review report with database source
- âœ… Suggesting new patterns when similar bugs are discovered
- âŒ NEVER ignoring checklist items to save time
- âŒ NEVER skipping database search for relevant code modifications

**Search Example**:
```
When modifying Awake() method:
1. Run: grep "Awake" -i path:.cursor/postmortem/categories/unity-lifecycle.md
2. Review: Read any matches found
3. Report: Flag in self-review if pattern applies
```

**This knowledge base grows with experience. Database contains historical patterns not listed here.**
