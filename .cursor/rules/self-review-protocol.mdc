---
description: AI Self-Review Protocol - Mandatory code review before submission
globs: .cs
alwaysApply: true
---

# AI Self-Review Protocol (MANDATORY)

> **Core Principle**: AI MUST perform self-review after code generation and report results transparently.

## Coding Standards Location

- [ ] **MUST**: All coding standards are defined in `my-base-rules.mdc`
  - ğŸ“‚ File: `.cursor/rules/my-base-rules.mdc`
  - ğŸ“‹ Contains: Clean Code, SOLID, DRY, File structure, Design patterns, Scope control
  - ğŸ¯ This file defines WHAT to check
  - ğŸ¯ Current file defines HOW to perform review

- [ ] **MUST**: Enforcement rules are defined in `enforce-rules.mdc`
  - ğŸ“‚ File: `.cursor/rules/enforce-rules.mdc`
  - ğŸ“‹ Contains: AI behavior, Rule priorities, Conflict resolution
  - ğŸ¯ This file defines execution protocol

---

## Trigger Conditions (When Self-Review is MANDATORY)

- [ ] **MUST**: Perform self-review when ANY of the following occurs
  - ğŸ“ Modified or added >50 lines of code
  - ğŸ”§ Refactored existing functionality
  - ğŸ†• Added new class, method, or interface
  - ğŸ”„ Modified architecture or dependencies
  - ğŸ¯ Touched Unity lifecycle or event system
  - ğŸ“ Made unsolicited optimizations

---

## Self-Review Execution Flow

- [ ] **MUST**: Follow this exact sequence after code generation

### Step 1: Rule Compliance Check
```
âœ… Action: Open and read my-base-rules.mdc
âœ… Action: Verify against coding standards:
   - Environment Requirements (CRLF, no graphical chars)
   - File & Class Structure (One File One Class, parameters â‰¤3)
   - Code Quality (file â‰¤200 lines, method â‰¤20 lines)
   - SOLID principles (all 5 principles)
   - DRY principle (no duplication)
   - Scope Control (respect user-specified scope)
   - Design Patterns (avoid complex if/else)
âœ… Action: Verify ALL rules from enforce-rules.mdc
ğŸ“ Timing: Before submitting response
ğŸ“‚ Standards Source: .cursor/rules/my-base-rules.mdc
```

### Step 2: Postmortem Pattern Check
```
âœ… Action: Compare against postmortem-patterns.mdc
âœ… Action: Identify if any known bug patterns triggered
ğŸ“ Timing: After rule compliance check
```

### Step 3: Generate Review Report
```
âœ… Action: Create structured review report (see format below)
âœ… Action: Include report in response to user
ğŸ“ Timing: Before submitting response
âŒ DO NOT: Skip report even if all checks pass
```

### Step 4: Decision Point
```
If violations â‰¥ 3: STOP and propose solutions
If violations < 3: Proceed with warning
If violations = 0: Proceed
```

---

## Review Report Format (MANDATORY OUTPUT)

- [ ] **MUST**: Include this report after EVERY code modification
- [ ] **MUST**: Reference standards from `my-base-rules.mdc` in report

````markdown
## Self-Review Report

### Modification Summary
- **Scope**: [N] files, [M] lines
- **Type**: [Added/Modified/Refactored/Deleted]
- **Risk**: [ğŸŸ¢ Low / ğŸŸ¡ Medium / ğŸ”´ High]

### Passed Checks
- [List key checks that passed, reference my-base-rules.mdc standards]
- Example: "Clean Code: Methods â‰¤20 lines, params â‰¤3 (my-base-rules.mdc)"
- Example: "SOLID: Single responsibility maintained (my-base-rules.mdc)"

### Warnings
- [List potential risks for user attention]
- [If none, write "None"]

### Failed Checks
- [List failed checks with explanation and rule reference]
- Example: "âŒ File length exceeds 200 lines (my-base-rules.mdc: Code Quality)"
- [If none, write "None"]

### Recommended Actions
- [Additional testing needed?]
- [Code review needed?]
- [Performance testing needed?]
````

---

## Mandatory Stop Conditions

- [ ] **MUST**: STOP code generation and discuss with user when:
  - âŒ Failed checks â‰¥ 3
  - âŒ Triggered known bug pattern from postmortem
  - âŒ Modified >5 files without explicit authorization
  - âŒ Violated SOLID principles with no immediate fix
  - âŒ Introduced new external dependencies

---

## Failure Handling Protocol

- [ ] **MUST**: When review fails, follow this protocol:

### Step 1: Stop Immediately
```
âŒ DO NOT: Continue generating code
âŒ DO NOT: Attempt automatic fixes
âœ… DO: Stop and report to user
```

### Step 2: Report Problem
```
âœ… Action: Explain what failed
âœ… Action: Explain why it's a problem
âœ… Action: Explain impact
```

### Step 3: Propose Solutions
```
âœ… Action: Provide exactly 3 options:
  - Option A: Best practice (may take more time)
  - Option B: Compromise (balance quality & speed)
  - Option C: Quick fix (accept technical debt)
âœ… Action: Include time estimate for each
```

### Step 4: Wait for Decision
```
â¸ï¸ Action: Wait for user to choose
âŒ DO NOT: Proceed without confirmation
```

---

## Review Exemptions

- [ ] **MAY**: Skip detailed review (but still provide brief summary) when:
  - Modified <10 lines AND only comments/formatting
  - Deleted unused code only
  - Pure data class (POCO/DTO) with no logic
  - User explicitly requests "quick prototype, skip review"

---

## Enforcement Mechanism

- [ ] **MUST**: Self-check before submitting response
  - â“ Did I generate code >50 lines? â†’ Review required
  - â“ Did I refactor anything? â†’ Review required
  - â“ Did I add new class/method? â†’ Review required
  - â“ Did I check against my-base-rules.mdc? â†’ If not, CHECK IT NOW
  - â“ Did I include review report? â†’ If not, ADD IT NOW

- [ ] **MUST NOT**: Submit code without review report
  - âŒ Violation: Submitting code without review when required
  - âœ… Correct: Always include review report when triggered
  
- [ ] **MUST**: Reference my-base-rules.mdc in review report
  - âŒ Violation: Generic checks without rule reference
  - âœ… Correct: "File length exceeds 200 lines (my-base-rules.mdc: Code Quality)"

---

## Review Report Examples

### Example 1: Pass (Low Risk)

```markdown
## Self-Review Report

### Modification Summary
- **Scope**: 1 file, 45 lines
- **Type**: Added
- **Risk**: ğŸŸ¢ Low

### Passed Checks
- Clean Code: Methods â‰¤20 lines, params â‰¤3 (my-base-rules.mdc: Code Quality)
- SOLID: Single responsibility maintained (my-base-rules.mdc: MUST Requirements)
- Scope Control: No modifications outside intended scope (my-base-rules.mdc)
- Environment: CRLF line endings, ASCII only (my-base-rules.mdc: Environment)

### Warnings
- None

### Failed Checks
- None

### Recommended Actions
- âœ… Ready to use
- Consider adding unit tests for edge cases
```

### Example 2: Fail (High Risk - STOP)

```markdown
## Self-Review Report

### Modification Summary
- **Scope**: 3 files, 280 lines
- **Type**: Refactored
- **Risk**: ğŸ”´ High

### Passed Checks
- Clean Code: Naming is clear (my-base-rules.mdc: Code Quality)
- DRY: No code duplication (my-base-rules.mdc: MUST Requirements)

### Warnings
- Changes affect core system, needs full regression testing

### Failed Checks
- âŒ File length: 315 lines exceeds 200 line limit (my-base-rules.mdc: Code Quality Standards)
- âŒ Missing event unsubscribe: OnSkillTriggered event (Unity best practice)
- âŒ Triggered Postmortem P001: lifecycle order issue (postmortem-patterns.mdc)

### Recommended Actions
- ğŸ›‘ STOP - Need to discuss solutions

---

## Solution Options

**Option A: Full Refactor (Recommended)**
- Split ActorController into 3 classes
- Properly implement event lifecycle
- Estimated time: 30 minutes

**Option B: Minimal Fix**
- Fix event leak only
- Accept class length technical debt
- Estimated time: 5 minutes

**Option C: Revert**
- Rollback this refactor
- Improve incrementally in smaller steps
- Estimated time: 2 minutes

Which option do you prefer?
```

---

## AI Commitment

**I, as the AI assistant, commit to**:
- âœ… Performing self-review EVERY time trigger conditions are met
- âœ… Including review report in EVERY response with code changes
- âœ… STOPPING immediately when â‰¥3 checks fail
- âœ… Transparently reporting ALL issues found
- âœ… NEVER skipping review to save time
- âŒ NEVER submitting code without required review

**If I violate this commitment**:
1. User should point out the missing review
2. I will acknowledge the violation
3. I will provide the missing review report
4. I will learn to avoid similar violations

---

## Monitoring Checklist for User

**Check if AI is following this protocol**:
- [ ] Did AI provide review report after code changes?
- [ ] Did report include all 5 sections (Summary, Passed, Warnings, Failed, Actions)?
- [ ] Did AI reference my-base-rules.mdc in the report?
- [ ] Did AI stop when failures â‰¥3?
- [ ] Did AI propose 3 solutions when stopped?

**If AI skipped review without exemption reason**:
â†’ Point out: "You didn't provide self-review report"
â†’ AI will immediately provide it

**If AI didn't reference my-base-rules.mdc**:
â†’ Point out: "You didn't check against my-base-rules.mdc"
â†’ AI will re-check and provide updated report

---

## Summary

**AI MUST remember**:

> âœ… Self-review is MANDATORY, not optional
> âœ… Review report MUST be included in response
> âœ… ALL checks MUST reference my-base-rules.mdc
> âœ… Stop IMMEDIATELY when checks fail
> âœ… User satisfaction > output speed

**Coding standards location**: `.cursor/rules/my-base-rules.mdc`

**This is NOT optional. This is ENFORCED protocol.**
